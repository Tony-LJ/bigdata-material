
# 离线数仓开发经验整理

---

## 分区表写入技巧
- [业务场景:增量离线同步]()
```.text
1.上游Oracle有一个每日数据量新增很大，整体全量很大的表需要同步到大数据系统(Impala/hive)，并带有数据记录更新字段:update_time
ODS层：考虑到数据量巨大，由全量抽取改为基于update_time字段进行增量抽取；增量抽取条件：update_time >= sysdate-1
CREATE TABLE bi_ods.ods_zrsmt_oms_pdm_yield_record_to_hadoop (
  yield_record_id BIGINT,
  organization_id DOUBLE,
  ebs_mfg_code STRING,
  process_code STRING,
  process_name STRING,
  lot_num STRING,
  sales_order_number STRING,
  test_year_week STRING,
  kw_part_num STRING,
  layer_num STRING,
  layup_num STRING,
  product_sample STRING,
  surface_treatment_name STRING,
  customer_code STRING,
  customer_description STRING,
  kwcolcode STRING,
  line_code STRING,
  test_device_code STRING,
  shift STRING,
  create_by STRING,
  test_by STRING,
  amount_unit STRING,
  test_amount DOUBLE,
  yield_amount DOUBLE,
  test_time STRING,
  create_time STRING,
  test_pnl_amount DOUBLE,
  rework_amount DOUBLE,
  update_time STRING,
  check_method STRING,
  check_type STRING,
  board_type STRING
)COMMENT 'Imported by sqoop on 2025/05/21 06:00:07'
2.从同步性能角度，考虑使用以update_time字段作为增量同步识别字段；
DWD层：
CREATE TABLE bi_dwd.dwd_zrsmt_oms_pdm_yield_record_to_hadoop (
  yield_record_id BIGINT,
  organization_id DOUBLE,
  ebs_mfg_code STRING,
  process_code STRING,
  process_name STRING,
  lot_num STRING,
  sales_order_number STRING,
  test_year_week STRING,
  kw_part_num STRING,
  layer_num STRING,
  layup_num STRING,
  product_sample STRING,
  surface_treatment_name STRING,
  customer_code STRING,
  customer_description STRING,
  kwcolcode STRING,
  line_code STRING,
  test_device_code STRING,
  shift STRING,
  create_by STRING,
  test_by STRING,
  amount_unit STRING,
  test_amount DOUBLE,
  yield_amount DOUBLE,
  test_time STRING,
  create_time STRING,
  test_pnl_amount DOUBLE,
  rework_amount DOUBLE,
  update_time STRING,
  check_method STRING,
  check_type STRING,
  board_type STRING
)
PARTITIONED BY ( pt_d STRING COMMENT '天分区')
comment '工厂过数明细表'
3.根据update_time分区动态写入分区,实现数据表增量同步
insert overwrite table  bi_data.dwd_zrsmt_oms_pdm_yield_record_to_hadoop  
partition (pt_m)
    select 
    yield_record_id,
    organization_id,
    ebs_mfg_code,
    process_code,
    process_name,
    lot_num,
    sales_order_number,
    test_year_week,
    kw_part_num,
    layer_num,
    layup_num,
    product_sample,
    surface_treatment_name,
    customer_code,
    customer_description,
    kwcolcode,
    line_code,
    test_device_code,
    shift,
    create_by,
    test_by,
    amount_unit,
    test_amount,
    yield_amount,
    test_time,
    create_time,
    test_pnl_amount,
    rework_amount,
    update_time,
    check_method,
    check_type,
    board_type,
    to_date(trunc(update_time,'dd'))   as pt_d 
from    bi_ods.ods_cux_cux_mes_data_flow_all
where   to_date(update_time)  >= to_date(trunc(date_sub(now(),1),'dd'));
```


## 文本操作
- [业务场景:文本替换]()
  - [REGEXP_REPLACE]()
    ```.text
    函数表达式：将 str 中与 regexp 匹配的所有子字符串都替换为 rep。
    regexp_replace(str, regexp, rep [, position] )
    参数：
    str：匹配的 STRING 表达式。
    regexp：具有匹配模式的 STRING 表达式。
    rep：作为替换字符串的 STRING 表达式。
    position：一个大于 0 的可选整型数字文本，指示开始匹配的位置。 默认值为 1
    
    示例1：
    SELECT REGEXP_REPLACE('(jackie)&（jackie chan）', '\\(|\\)|（|）', ' ')
    效果：(jackie)&（jackie chan） ->  jackie & jackie chan 
    
    示例2：
    select
     to_date(a.field0006)                                      as req_date
    ,to_date(if(a.finishedflag = '1',modify_date,a.field0006)) as import_date
    ,a.field0001                                               as oa_sn
    ,a.field0163                                               as vendor_code
    ,a.field0012                                               as vendor_name
    ,'合格'                                                    as vendor_category
    ,regexp_replace(
       regexp_replace(
         regexp_replace(concat_ws('|',if(a.field0135 = '1','SZPCB' ,'')
                                     ,if(a.field0136 = '1','LCPCB' ,'')
                                     ,if(a.field0138 = '1','SZFPC' ,'')
                                     ,if(a.field0139 = '1','LCFPC' ,'')
                                     ,if(a.field0140 = '1','JXPCB' ,'')
                                     ,if(a.field0141 = '1','LCSMT' ,'')
                                     ,if(a.field0142 = '1','ZHFPC' ,'')
                                     ,if(a.field0144 = '1','ZRFPC' ,'')
                                     ,if(a.field0145 = '1','ZRSMT' ,'')
                                     ,if(a.field0152 = '1','ZHSLP' ,'')
                                     ,if(a.field0153 = '1','ZHHDI' ,'')
                                     ,if(a.field0154 = '1','ZHPCB' ,'')
                                     ,if(a.field0155 = '1','ZHHLC' ,'')
                                     ,if(a.field0165 = '1','HKKW'  ,'')
                                     ,if(a.field0180 = '1','GZPCB' ,'')
                                     ,if(a.field0137 = '1','LCMPCB','')
                                     ,if(a.field0143 = '1','LCMCCL','')
                                     ,if(a.field0213 = '1','THAKW' ,'')), '\\|{2,}', '|'),  -- 替换连续多个|为单个|
                                                                        '^\\|', ''),      -- 去除开头|
                                                                        '\\|$', '')       -- 去除结尾|
                                      as ou_list
    ,regexp_replace(
       regexp_replace(
         regexp_replace(concat_ws('|',if(a.field0013 = '1','降低成本'     ,'')
                                     ,if(a.field0014 = '1','新产品新工艺' ,'')
                                     ,if(a.field0015 = '1','品质要求'     ,'')
                                     ,if(a.field0016 = '1','客户要求'     ,'')
                                     ,if(a.field0017 = '1','其他'         ,'')), '\\|{2,}', '|'),  -- 替换连续多个|为单个|
                                                                                 '^\\|', ''),      -- 去除开头|
                                                                                 '\\|$', '')       -- 去除结尾|
                                      as imp_reason_type
    ,a.field0166                      as imp_reason
    ,if(finishedflag = '1','是','否') as finished_flg
    ,group_concat(if(a.field0133 = '-1',null,a.field0133))  as item_category
    from bi_data.dwd_formmain_9151      a
    where a.`state ` <> '0'
    and a.finishedflag <> '3'
    group by 1,2,3,4,5,6,7,8,9,10
    ;
    ```
- [业务场景:模糊匹配]()
  - []()
    ```.text

    ```













### 参考日期


